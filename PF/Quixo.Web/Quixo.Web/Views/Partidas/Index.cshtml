@model IEnumerable<Quixo.Web.Models.Partida>
@using Quixo.Web.Models

@{
    ViewBag.Title = "Partidas";
}

<h2>Partidas</h2>

@if (TempData["Mensaje"] != null)
{
    <div class="alert alert-info">
        @TempData["Mensaje"]
    </div>
}

<p>
    @Html.ActionLink("Crear nueva partida", "Crear", "Partidas", null, new { @class = "btn btn-primary" })

    @Html.ActionLink(
        "Ver partidas finalizadas",
        "Finalizadas",           // <-- nueva acción en PartidasController
        "Partidas",
        null,
        new { @class = "btn btn-success", style = "margin-left:10px;" })
</p>

@if (!Model.Any())
{
    <p>No hay partidas registradas todavía.</p>
}
else
{
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Id</th>
                <th>Modo</th>
                <th>Fecha creación</th>
                <th>Resultado</th>
                <th>Duración</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            @foreach (var p in Model)
            {
                // ==== TEXTO BONITO DEL RESULTADO SEGÚN MODO ====
                string textoResultado;

                if (p.Resultado == ResultadoPartida.EnCurso)
                {
                    textoResultado = "En curso";
                }
                else if (p.Modo == ModoPartida.DosJugadores)
                {
                    if (p.Resultado == ResultadoPartida.GanoJugador1)
                    {
                        textoResultado = "Ganó Jugador 1";
                    }
                    else if (p.Resultado == ResultadoPartida.GanoJugador2)
                    {
                        textoResultado = "Ganó Jugador 2";
                    }
                    else
                    {
                        textoResultado = p.Resultado.ToString();
                    }
                }
                else // ModoPartida.CuatroJugadores
                {
                    if (p.Resultado == ResultadoPartida.GanoJugador1)
                    {
                        textoResultado = "Ganó Equipo A (círculo)";
                    }
                    else if (p.Resultado == ResultadoPartida.GanoJugador2)
                    {
                        textoResultado = "Ganó Equipo B (cruz)";
                    }
                    else
                    {
                        textoResultado = p.Resultado.ToString();
                    }
                }

                string duracion = p.DuracionTotal == TimeSpan.Zero
                    ? "00:00:00"
                    : p.DuracionTotal.ToString(@"hh\:mm\:ss");

                <tr>
                    <td>@p.Id</td>
                    <td>@p.Modo</td>
                    <td>@p.FechaCreacion</td>
                    <td>@textoResultado</td>
                    <td>@duracion</td>
                    <td>
                        @Html.ActionLink(
                            "Ver detalle",
                            "Detalle",
                            "Partidas",
                            new { id = p.Id },
                            new { @class = "btn btn-sm btn-info" })

                        @Html.ActionLink(
                            "Exportar XML",
                            "ExportarXml",
                            "Partidas",
                            new { id = p.Id },
                            new { @class = "btn btn-sm btn-success", style = "margin-left:5px;" })

                        @* Botón para eliminar SOLO partidas en curso *@
                        @if (p.Resultado == ResultadoPartida.EnCurso)
                        {
                            using (Html.BeginForm("Eliminar", "Partidas", FormMethod.Post, new { style = "display:inline-block; margin-left:5px;" }))
                            {
                                @Html.AntiForgeryToken();
                                @Html.Hidden("id", p.Id);
                                <button type="submit" class="btn btn-sm btn-danger"
                                        onclick="return confirm('¿Seguro que desea eliminar esta partida en curso?');">
                                    Eliminar
                                </button>
                            }
                        }
                    </td>
                </tr>
            }
        </tbody>
    </table>

    <p>
        @Html.ActionLink("Volver al inicio", "Index", "Home", null, new { @class = "btn btn-default" })
    </p>
}
